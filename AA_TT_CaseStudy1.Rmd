---
title: "Aundrae_Allison_Tamas Toth_MSDS_6306_CaseStudy1"
author: "Tamas Toth"
date: '2/9/2022'
output: html_document
---

#### Loading the necessary R libraries for the analysis

```{r message = FALSE}
# Load the necessary libraries
library(knitr)
library(rmarkdown)
library(ggpubr)
library(dplyr)
library(tidyr)
library(plyr)
library(ggplot2)
library(maps)
library(mapproj)
library(sf)
library(usmap)
library(urbnmapr)
library(tidyverse)
library(mice)
library(VIM)
library(lattice)
library(ggthemes)
library(e1071)
library(class)
library(caret)
library(stringr)
library(sjPlot)
library(data.table)

set.seed(329)
```

#### Read the data files

```{r}
#Read the files
beers = read.csv(file = '/Users/ttoth76/Downloads/CaseStudy1/Beers.csv', 
              sep = ',', header = TRUE)

breweries = read.csv(file = '/Users/ttoth76/Downloads/CaseStudy1/Breweries.csv', 
              sep = ',', header = TRUE)

# 3rd party data to augment current dataset and provide additional insight
beers_consumption = read.csv(file = '/Users/ttoth76/Downloads/CaseStudy1/beer_consumption_by_state_2021.csv', 
              sep = ',', header = TRUE)
```

#### Data Preparation

##### - Verify missing values (NA)

```{r}
# verify missing values & white spaces
sapply(breweries, function(x) sum(is.na(x)))
```

#### There are no missing values in the 'breweries' dataset.

```{r}
sapply(beers, function(x) sum(is.na(x)))
```

#### There are 62 missing values in the ABV and 1005 missing values in the IBU variable in the 'beers' dataset.

```{r}
# remove leading and trailing white spaces for features required for the analysis
pattern = "(^ +| +$)"
replacement = ""
breweries$State = sub(pattern = pattern, replacement = replacement, x=breweries$State)
beers$Style = sub(pattern = pattern, replacement = replacement, x=beers$Style)
```

### Q1: How many breweries are present in each state?

```{r message = FALSE, warning = FALSE}
# How many breweries are present in each state?
nbs = breweries %>% group_by(State) %>% dplyr::summarise(nobrews = n())
nbs_df = as.data.frame(nbs)
#sum(nbs$nobrews)
#table(breweries$State)

#diplay this on a map
# Data prep
us_map_fips = fips_info()
consumption = merge(us_map_fips, beers_consumption, 'full')
names(nbs)[names(nbs) == 'State'] = 'abbr'
nbs_map_data = merge(nbs, us_map_fips, 'abbr')

names(nbs_map_data)[names(nbs_map_data) == 'abbr'] = 'state_abbv'

#create state shape file
states_shape = get_urbn_map(map = "states", sf = TRUE)
# calculate the geo centroid of each state
center_states = st_centroid(states_shape)
# get longitude and latitude data
lan_lat = str_replace_all(center_states$geometry, "[()]", "")
lan_lat_noc = str_replace_all(lan_lat, "c", "")
center_states = mutate(center_states, lan = str_split_fixed(lan_lat_noc, ",", n=2)[,1])
center_states = mutate(center_states, lat = str_split_fixed(lan_lat_noc, ",", n=2)[,2])
center_states$lan = as.numeric(center_states$lan)
center_states$lat = as.numeric(center_states$lat)
#add latitude and longitude data to breweris dataset
nbs_map_data_sf = merge(nbs_map_data, center_states, by = "state_abbv")

# Plot the result (using budwiser logo colors)
plot_usmap(data = nbs_map_data_sf, values = "nobrews", regions = "states", 
           labels = TRUE, label_color = "black") + 
  labs(title = "Number of Budweiser Breweries by US States") + 
  scale_fill_continuous(low = "white", high ="#C8102E", 
  name = "# of breweries",label = scales::comma) + 
  theme(legend.position = "right") +
  theme(panel.background=element_blank()) +
  ggrepel::geom_label_repel(data = nbs_map_data_sf,
             aes(x = lan, y = lat, label = nobrews),
             size = 8, alpha = 0.8,
             label.r = unit(0.5, "lines"), label.size = 0.5,
             segment.color = "red", segment.size = 1,
             seed = 1002) 
```

```{r}

# Additional insight about beer consumption by state per capita in 2021
# data source: https://beerinfo.com/beer-consumption-by-state-per-capita/
# purpose is to contrast the highest # of breweries with the largest consuming states

plot_usmap(data = consumption, values = "consumption", regions = "states", 
           labels = TRUE, label_color = "black") + 
  labs(title = "Beer Consumption by State per Capita") + 
  scale_fill_continuous(low = "white", high ="#C8102E", 
  name = "gallons",label = scales::comma) + 
  theme(legend.position = "right") +
  theme(panel.background=element_blank())
```

#### Display the above breweries per state infomration in a table format

```{r results='asis', echo=FALSE}
paged_table(nbs_df)
```

### Q2: Merge beer data with the breweries data. Print the first 6 observations and the last six observations to check the merged file.

```{r}
# Merge beer data with the breweries data. Print the first 6 observations and the last six observations to check the merged file.  

## Rename some features for easier join
names(breweries)[names(breweries) == 'Brew_ID'] = 'Brewery_id'

## Merge
brew_beers = merge(breweries, beers, by = "Brewery_id")

# rename features to a more meaningful name after merge
names(brew_beers)[names(brew_beers) == 'Name.x'] = 'Brewery_Name'
names(brew_beers)[names(brew_beers) == 'Name.y'] = 'Beer_Name'
```

### First 6 observations

```{r}
head(brew_beers, n=6)
```

### Last 6 observations

```{r}
tail(brew_beers, n=6)
```

### Q3: Address the missing values in each column.

```{r}
# Address the missing values in each column (NA as well as empty strings).
sapply(brew_beers, function(x) sum(is.na(x)))
cat("There are 62 ABV and 1005 IBU missing values (NA) in the dataset")
sapply(brew_beers, function(x) sum(x == ""))
cat("There are 5 empty strings in the 'Style' vaiable in the dataset")
# There are 5 empty values in the Style column
# Let's replace them with NA and impute mode()
brew_beers$Style[brew_beers$Style == ""] = NA
brew_beers$Style[is.na(brew_beers$Style)] = median(brew_beers$ABV, na.rm = TRUE)

# Calculate mode for imputation
styles = unique(brew_beers$Style[!is.na(brew_beers$Style)])
style_mode = styles[which.max(tabulate(match(brew_beers$Style, styles)))]
brew_beers$Style[is.na(brew_beers$Style)] = style_mode

# Impute median IBU value by Style groups 
# (I assume the IBU values are more similar in each style group therefore
# I don't take the median of all the beers' IBU but much rather grouping them by Style and calculate the 
# median). Same for the ABV content.
brew_beers = brew_beers %>%
   group_by(Style) %>%
   mutate(IBU = replace(IBU,is.na(IBU), median(IBU, na.rm = TRUE)))

# Impute median ABV value by Style groups
brew_beers = brew_beers %>%
   group_by(Style) %>%
   mutate(ABV = replace(ABV,is.na(ABV), median(ABV, na.rm = TRUE)))

# convert the tibble to data frame
brew_beers = as.data.frame(brew_beers)
```

```{r total_uniq_style, prod_co, echo=FALSE, results='asis'}
# Number of unique bear styles and how many of these are from Colorado where the highest number of breweries are
most_brew = brew_beers[brew_beers$State == 'CO',]
total_uniq_style = sum(count(unique(brew_beers$Style))[2])
prod_co = sum(count(unique(most_brew$Style))[2])
cat(paste0("The total number of unique style beers produced: ", total_uniq_style, "\n"),sep = "\n")
cat(paste0("Number of unique style beers produced in Colorado: ", prod_co, "\n"),sep = "\n")
cat(paste0("Colorado is producting: ", prod_co/total_uniq_style*100, "% of the total beer styles.\n"),sep = "\n")
```

### Q3:Compute the median alcohol content and international bitterness unit for each state. Plot a bar chart to compare.

```{r}
# Compute the median alcohol content and international bitterness unit for each state. 
# Plot a bar chart to compare.

# ABV Median Values by State

ABV_IBU_State = brew_beers %>%                                      
  group_by(State) %>%                       
  summarise_at(vars(ABV, IBU),            
               list(name = median))

ABV_IBU_State = as.data.frame(ABV_IBU_State)
ABV_IBU_State = ABV_IBU_State %>% arrange(ABV_name)

ggplot(ABV_IBU_State, aes(x=State, y = ABV_name)) + 
  geom_bar(stat = 'identity', fill = '#C8102E') + 
  ggtitle('ABV Median Values by State') + 
  geom_text(aes(label = ABV_name), vjust = 0.5, hjust = -0.1,
            data = ABV_IBU_State) +
  xlab("States") + ylab("median")+
  coord_flip() + 
  theme(legend.position = "none") + theme_tufte() + theme(plot.title = element_text(hjust = 0.5))


#IBU Median Values by State
ggplot(ABV_IBU_State, aes(x=State, y = IBU_name)) + 
  geom_bar(stat = 'identity', fill = '#C8102E') + 
  ggtitle('IBU Median Values by State') + 
  geom_text(aes(label = IBU_name), vjust = 0.5, hjust = -0.1, 
            data = ABV_IBU_State) +
  xlab("States") + ylab("Median")+
  theme(legend.position = "none") + coord_flip() + theme_tufte() + theme(plot.title = element_text(hjust = 0.5))
```

### Q3: Which state has the maximum alcoholic (ABV) beer? 
###     Which state has the most bitter (IBU) beer?
```{r}
#Which state has the maximum alcoholic (ABV) beer? Which state has the most bitter (IBU) beer?
max_abv = as.data.frame(brew_beers[which.max(brew_beers$ABV),])
max_abv$fips = 08
max_ibu = brew_beers[which.max(brew_beers$IBU),]
max_ibu$fips = 41
long_co = -580957.756

#display the max ABV state on the map
plot_usmap(data = max_abv, values = "ABV",include = c("CO"),labels = FALSE, label_color = "white") +
  labs(title = "Colorado") +
  theme(panel.background = element_rect(color = "blue")) +
  scale_fill_continuous(low = "white", high ="#C8102E", 
  name = "# of breweries",label = scales::comma) + 
  theme(legend.position = "none") +
  theme(panel.background=element_blank()) +
  ggrepel::geom_label_repel(data = max_abv,
             aes(x = -479518.34, y = long_co*1.150490688483037, label = paste('ABV =', ABV)),
             size = 4, alpha = 0.8,
             #label.r = unit(0.5, "lines"), label.size = 0.5,
             segment.color = "red", segment.size = 1,
             seed = 1002) +
  
  ggrepel::geom_label_repel(data = max_abv,
             aes(x = -479518.34, y = long_co, label = "Colorado"),
             size = 4, alpha = 0.8,
             label.r = unit(0.5, "lines"), label.size = 0.5,
             segment.color = "red", segment.size = 1,
             seed = 1002) +
  
   ggrepel::geom_label_repel(data = max_abv,
             aes(x = -479518.34, y = long_co*1.05163886649273, label = Brewery_Name),
             size = 4, alpha = 0.8,
             label.r = unit(0.5, "lines"), label.size = 0.5,
             segment.color = "red", segment.size = 1,
             seed = 1002) +
  
  ggrepel::geom_label_repel(data = max_abv,
             aes(x = -479518.34, y = long_co*1.100064777487883, label = Beer_Name),
             size = 4, alpha = 0.8,
             label.r = unit(0.5, "lines"), label.size = 0.5,
             segment.color = "red", segment.size = 1,
             seed = 1002)


#display the max IBU state on the map
long_or = 180000.391
plot_usmap(data = max_ibu, values = "IBU",include = c("OR"),labels = FALSE, label_color = "white") +
  labs(title = "Oregon") +
  theme(panel.background = element_rect(color = "blue")) +
  scale_fill_continuous(low = "white", high ="#C8102E", 
  name = "# of breweries",label = scales::comma) + 
  theme(legend.position = "none") +
  theme(panel.background=element_blank()) +
  ggrepel::geom_label_repel(data = max_ibu,
             aes(x = -1624240.82, y = long_or*0.402223368670349, label = paste('IBU =', IBU)),
             size = 4, alpha = 0.8,
             label.r = unit(0.5, "lines"), label.size = 0.5,
             segment.color = "red", segment.size = 1,
             seed = 1002) +
  ggrepel::geom_label_repel(data = max_ibu,
             aes(x = -1624240.82, y = long_or, label = "Oregon"),
             size = 4, alpha = 0.8,
             label.r = unit(0.5, "lines"), label.size = 0.5,
             segment.color = "red", segment.size = 1,
             seed = 1002) +

ggrepel::geom_label_repel(data = max_ibu,
             aes(x = -1624240.82, y = long_or*(143000.391/long_or), label = Brewery_Name),
             size = 4, alpha = 0.8,
             label.r = unit(0.5, "lines"), label.size = 0.5,
             segment.color = "red", segment.size = 1,
             seed = 1002) +
  
ggrepel::geom_label_repel(data = max_ibu,
             aes(x = -1624240.82, y = long_or*(108000.391/long_or), label = Beer_Name),
             size = 4, alpha = 0.8,
             label.r = unit(0.5, "lines"), label.size = 0.5,
             segment.color = "red", segment.size = 1,
             seed = 1002) 



```

### Q4: Comment on the summary statistics and distribution of the ABV variable.
```{r}
# Comment on the summary statistics and distribution of the ABV variable.
summary(brew_beers$ABV)
par(mfrow=c(1,2))
hist(brew_beers$ABV, main = 'ABV distribution', col ="#C8102E", xlab = 'Alcoholic Content')
boxplot(brew_beers$ABV, main = 'ABV distribution', col ="#C8102E", ylab = 'Alcoholic Content')
means = mean(brew_beers$ABV)
points(means,col="yellow",pch=18)


abline(h=mean(brew_beers$ABV))


# 25% of the products alcohol content is less than 0.05
# 50% of the products alcohol content is 0.056
# 75% of the products alcohol content is less than 0.067

# Average alcohol content of the products is 0.056
# Product portfolio is mostly comprised of mild alcohol content beers


```

#### Q7: Is there an apparent relationship between the bitterness of the beer and its alcoholic content? Draw a scatter plot.  Make your best judgment of a relationship and EXPLAIN your answer.
```{r message==FALSE, warning=FALSE}
# Is there an apparent relationship between the bitterness of the beer and its alcoholic content? 
# Draw a scatter plot.  Make your best judgment of a relationship and EXPLAIN your answer.

beers %>% 
ggplot(aes(x = ABV, y = IBU)) + geom_point(color = "#C8102E", shape=1) + 
  geom_smooth(method = "lm", color = "#00A1E1") + ggtitle("Correlation between IBU and ABV") + 
  xlab("ABV") + ylab("IBU") + 
  theme_tufte() +
  theme(plot.title = element_text(hjust = 0.5))

pearson_r = cor(brew_beers$ABV, brew_beers$IBU, use = "everything")
print(pearson_r)

```

#### Q8: Budweiser would also like to investigate the difference with respect to IBU and ABV #### between IPAs (India Pale Ales) and other types of Ale (any beer with “Ale” in its 
#### name other than IPA).  You decide to use KNN classification to investigate this 
#### relationship.  Provide statistical evidence one way or the other. 
```{r}
# Budweiser would also like to investigate the difference with respect to IBU and ABV # between IPAs (India Pale Ales) and other types of Ale (any beer with “Ale” in its 
# name other than IPA).  You decide to use KNN classification to investigate this 
# relationship.  Provide statistical evidence one way or the other. 

# Prepare dataset for the KNN model. Let's filter for IPAs and Ales

data_for_modeling = brew_beers %>% dplyr::select(Style, ABV, IBU)
data_for_modeling$Style = gsub(".*(IPA).*", "\\1", data_for_modeling$Style, ignore.case = TRUE)
data_for_modeling$Style = gsub(".*(\\bAle\\b).*", "\\1", data_for_modeling$Style, ignore.case = TRUE)
data_for_modeling = filter(data_for_modeling, Style == 'IPA' | Style == 'Ale')
table(data_for_modeling$Style)
unique(data_for_modeling$Style)

data_for_modeling[grep("IPA", data_for_modeling$Style, ignore.case = TRUE),]
sum(data_for_modeling[data_for_modeling$Style =="English India Pale Ale (IPA)",])


data_for_modeling[str_detect(data_for_modeling$Style, "IPA|Ale"),]


ale_percent = (count(data_for_modeling[data_for_modeling$Style == 'Ale','Style'])[2] / dim(data_for_modeling)[1])*100

IPA_percent = (count(data_for_modeling[data_for_modeling$Style == 'IPA','Style'])[2] / dim(data_for_modeling)[1])*100


# 70/30 split of the dataset to train the modles:
train_70 = sample(1:dim(data_for_modeling)[1], round(0.7*dim(data_for_modeling)[1]))
train = data_for_modeling[train_70,]
test = data_for_modeling[-train_70,]
dim(train)

# Solution with KNN model
# Let's determine the best k value first based on accuracy

Accuracy_matrix = matrix(nrow=100)
                        
for (i in 1:100)
{
  CM = confusionMatrix(table(knn(train[,c("ABV", "IBU")], test[,c("ABV", "IBU")], train$Style, k = i, prob = TRUE), test$Style))$overall[1]
  Accuracy_matrix[i]=CM
}

best_k = which.max(Accuracy_matrix)

fit = knn(train[,c("ABV", "IBU")], test[,c("ABV", "IBU")], train$Style, k = best_k, prob = FALSE)
confusionMatrix(table(fit, test$Style))

# Plot predicted values
plot.df = data.frame(test, predicted = fit)
plot.df1 = data.frame(x = plot.df$ABV, 
                      y = plot.df$IBU, 
                      predicted = plot.df$predicted)

find_hull = function(df) df[chull(df$x, df$y), ]
boundary = ddply(plot.df1, .variables = "predicted", .fun = find_hull)

predict_plot = ggplot(plot.df, aes(ABV, IBU, color = predicted, fill = predicted)) + 
  geom_point(size = 5) + 
  geom_polygon(data = boundary, aes(x,y), alpha = 0.5)

# Plot original data
plot.df1 = data.frame(x = plot.df$ABV, 
                      y = plot.df$IBU, 
                      Style = plot.df$Style)

find_hull = function(df) df[chull(df$x, df$y), ]
boundary = ddply(plot.df1, .variables = "Style", .fun = find_hull)

orig_labels = ggplot(plot.df, aes(ABV, IBU, color = Style, fill = Style)) + 
  geom_point(size = 5) + 
  geom_polygon(data = boundary, aes(x,y), alpha = 0.5)

ggarrange(orig_labels,predict_plot,
                labels=c("Labeled","Predicted"),
                 ncol=1,nrow=2)



#### two sample t-test to prove difference
t.test(data_for_modeling$ABV, data_for_modeling$IBU, alternative = 'two.sided', var.equal = TRUE)
### failed to reject the null hypothesis, there is not enough evidence to suggest the ABV and IBU are contributing to the type of beer differently. 

confusionMatrix(table(knn.cv(data_for_modeling[,c('ABV','IBU')],data_for_modeling$Style, k = 5), data_for_modeling$Style))

# Solution with NB model
model = naiveBayes(train[,c('ABV','IBU')],train$Style)
  CM = confusionMatrix(table(predict(model, test[,c('ABV','IBU')], type = 'class'), test$Style))
  CM
```  
